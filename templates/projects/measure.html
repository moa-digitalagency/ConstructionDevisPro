{% extends "base.html" %}
{% block title %}Métrés - {{ plan.name }}{% endblock %}
{% block page_title %}Métrés - {{ plan.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <a href="{{ url_for('projects.view', project_id=project.id) }}" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-arrow-left mr-2"></i> Retour au projet
        </a>
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">Échelle: {{ "%.4f"|format(plan.scale_factor|float) if plan.scale_factor else '-' }} m/px</span>
        </div>
    </div>
    
    <div class="grid lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="mb-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">{{ plan.name }}</h2>
                    <div class="flex items-center space-x-2">
                        <button id="tool-polygon" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">
                            <i class="fas fa-draw-polygon mr-1"></i> Polygone
                        </button>
                        <button id="tool-line" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                            <i class="fas fa-ruler mr-1"></i> Ligne
                        </button>
                        <button id="tool-magic" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50" title="Détection automatique">
                            <i class="fas fa-magic mr-1"></i> Auto
                        </button>
                        <button id="btn-clear" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg text-sm hover:bg-red-50">
                            <i class="fas fa-trash mr-1"></i> Effacer
                        </button>
                    </div>
                </div>
                
                <div id="canvas-container" class="border rounded-lg overflow-hidden bg-gray-100 relative" style="height: 600px;">
                    <canvas id="pdf-canvas" class="absolute top-0 left-0"></canvas>
                    <canvas id="draw-canvas" class="absolute top-0 left-0 cursor-crosshair"></canvas>
                    <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 hidden flex items-center justify-center z-10">
                        <div class="text-center">
                            <i class="fas fa-circle-notch fa-spin text-4xl text-primary mb-2"></i>
                            <p class="font-medium text-gray-800">Détection en cours...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">Nouvelle pièce</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" id="room_name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Salon, Chambre 1...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="room_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="salon">Salon</option>
                            <option value="chambre">Chambre</option>
                            <option value="cuisine">Cuisine</option>
                            <option value="sdb">Salle de bain</option>
                            <option value="wc">WC</option>
                            <option value="couloir">Couloir</option>
                            <option value="bureau">Bureau</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Surface calculée</label>
                        <div id="calculated_area" class="px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-lg font-semibold text-primary">
                            - m²
                        </div>
                    </div>
                    
                    <button id="btn-save-room" disabled
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                        <i class="fas fa-save mr-2"></i>
                        Enregistrer la pièce
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">Pièces définies</h3>
                
                <div id="rooms-list" class="space-y-2 max-h-60 overflow-y-auto">
                    {% for room in project.rooms %}
                    <div class="p-3 border rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-gray-800">{{ room.name }}</span>
                            <span class="text-sm text-primary">{{ room.area|round(2) if room.area else '-' }} m²</span>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-sm">Aucune pièce définie</p>
                    {% endfor %}
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between text-lg font-semibold">
                        <span>Total</span>
                        <span class="text-primary" id="total-area">
                            {{ project.rooms|sum(attribute='area')|round(2) if project.rooms else 0 }} m²
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    window.MEASURE_CONFIG = {
        scaleFactor: {{ plan.scale_factor or 1 }},
        fileType: '{{ plan.file_type }}',
        filePath: '{{ plan.file_path }}',
        projectId: {{ project.id }},
        planId: {{ plan.id }}
    };
</script>
<script src="{{ url_for('static', filename='js/projects/measure.js') }}"></script>
{% endblock %}
