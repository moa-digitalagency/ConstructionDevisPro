{% extends "base.html" %}
{% block title %}Calibration - {{ plan.name }}{% endblock %}
{% block page_title %}Calibration du plan{% endblock %}

{% block content %}
<div class="space-y-6">
    <a href="{{ url_for('projects.plans', project_id=project.id) }}" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-arrow-left mr-2"></i> Retour aux plans
    </a>
    
    <div class="grid lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="mb-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">{{ plan.name }}</h2>
                    <div class="text-sm text-gray-500">
                        Cliquez sur deux points pour définir l'échelle
                    </div>
                </div>
                
                <div id="canvas-container" class="border rounded-lg overflow-hidden bg-gray-100" style="height: 600px;">
                    {% if plan.file_type == 'pdf' %}
                    <canvas id="pdf-canvas" class="w-full h-full cursor-crosshair"></canvas>
                    {% else %}
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-drafting-compass text-4xl mb-2"></i>
                            <p>Aperçu DWG/DXF non disponible</p>
                            <p class="text-sm">Veuillez convertir en PDF pour la calibration</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">Instructions</h3>
                <ol class="space-y-3 text-sm text-gray-600">
                    <li class="flex items-start space-x-2">
                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs flex-shrink-0">1</span>
                        <span>Cliquez sur le premier point d'une cote connue</span>
                    </li>
                    <li class="flex items-start space-x-2">
                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs flex-shrink-0">2</span>
                        <span>Cliquez sur le second point de la même cote</span>
                    </li>
                    <li class="flex items-start space-x-2">
                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs flex-shrink-0">3</span>
                        <span>Entrez la distance réelle en mètres</span>
                    </li>
                </ol>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">Calibration</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Point 1</label>
                        <input type="text" id="point1" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                               placeholder="Non défini">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Point 2</label>
                        <input type="text" id="point2" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                               placeholder="Non défini">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Distance réelle (m)</label>
                        <input type="number" id="real_distance" step="0.01" min="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Ex: 5.00">
                    </div>
                    
                    <button id="btn-calibrate" disabled
                            class="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-secondary transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                        <i class="fas fa-ruler mr-2"></i>
                        Calibrer
                    </button>
                    
                    <button id="btn-reset" class="w-full border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50 transition">
                        <i class="fas fa-redo mr-2"></i>
                        Recommencer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let point1 = null;
let point2 = null;
const canvas = document.getElementById('pdf-canvas');
const ctx = canvas ? canvas.getContext('2d') : null;

{% if plan.file_type == 'pdf' %}
const loadingTask = pdfjsLib.getDocument('/{{ plan.file_path }}');
loadingTask.promise.then(function(pdf) {
    pdf.getPage(1).then(function(page) {
        const container = document.getElementById('canvas-container');
        const scale = container.clientWidth / page.getViewport({scale: 1}).width;
        const viewport = page.getViewport({scale: scale});
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        page.render(renderContext);
    });
});

canvas.addEventListener('click', function(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    if (!point1) {
        point1 = {x: x, y: y};
        document.getElementById('point1').value = `(${x.toFixed(0)}, ${y.toFixed(0)})`;
        drawPoint(x, y, 'blue');
    } else if (!point2) {
        point2 = {x: x, y: y};
        document.getElementById('point2').value = `(${x.toFixed(0)}, ${y.toFixed(0)})`;
        drawPoint(x, y, 'red');
        drawLine(point1, point2);
        checkEnableButton();
    }
});
{% endif %}

function drawPoint(x, y, color) {
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.fill();
}

function drawLine(p1, p2) {
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.strokeStyle = 'green';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function checkEnableButton() {
    const distance = document.getElementById('real_distance').value;
    document.getElementById('btn-calibrate').disabled = !(point1 && point2 && distance);
}

document.getElementById('real_distance').addEventListener('input', checkEnableButton);

document.getElementById('btn-reset').addEventListener('click', function() {
    point1 = null;
    point2 = null;
    document.getElementById('point1').value = '';
    document.getElementById('point2').value = '';
    document.getElementById('real_distance').value = '';
    location.reload();
});

document.getElementById('btn-calibrate').addEventListener('click', function() {
    const distance = parseFloat(document.getElementById('real_distance').value);
    
    fetch('/api/plans/{{ plan.id }}/calibrate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            point1: point1,
            point2: point2,
            real_distance: distance
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Calibration réussie! Échelle: ' + data.scale_factor.toFixed(6) + ' m/px');
            window.location.href = '{{ url_for("projects.measure", project_id=project.id, plan_id=plan.id) }}';
        } else {
            alert('Erreur: ' + data.error);
        }
    });
});
</script>
{% endblock %}
